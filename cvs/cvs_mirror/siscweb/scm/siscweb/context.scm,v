head	1.3;
access;
symbols
	rel-0-6-dev:1.3.0.4
	rel-0-5-fix:1.3.0.2
	rel-0-5:1.3
	rel-0-5-dev-safe-frames:1.2.4.2.0.2
	Root_rel-0-5-dev-safe-frames:1.2.4.2
	rel-0-4-fix-0:1.2
	rel-0-5-dev:1.2.0.4
	rel-0-4-fix:1.2.0.2
	rel-0-3-fix-3:1.1.4.3
	rel-0-3-fix-2:1.1.4.2
	rel-0-3-fix:1.1.0.4
	rel-0-4-dev-sisc-1-11:1.1.2.2
	rel-0-4-dev:1.1.0.2;
locks; strict;
comment	@# @;


1.3
date	2007.04.12.03.51.18;	author acolomba;	state Exp;
branches;
next	1.2;

1.2
date	2006.09.03.01.42.23;	author acolomba;	state Exp;
branches
	1.2.4.1;
next	1.1;

1.1
date	2006.01.12.02.16.52;	author acolomba;	state dead;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2006.01.12.02.16.52;	author acolomba;	state Exp;
branches;
next	1.1.2.2;

1.1.2.2
date	2006.01.14.01.58.46;	author acolomba;	state Exp;
branches;
next	1.1.2.3;

1.1.2.3
date	2006.04.13.02.57.31;	author acolomba;	state Exp;
branches;
next	1.1.2.4;

1.1.2.4
date	2006.04.14.01.00.14;	author acolomba;	state Exp;
branches;
next	1.1.2.5;

1.1.2.5
date	2006.08.11.03.34.32;	author acolomba;	state Exp;
branches;
next	;

1.1.4.1
date	2006.01.12.02.16.52;	author acolomba;	state dead;
branches;
next	1.1.4.2;

1.1.4.2
date	2006.02.25.17.12.02;	author acolomba;	state Exp;
branches;
next	1.1.4.3;

1.1.4.3
date	2006.04.15.15.55.23;	author acolomba;	state Exp;
branches;
next	;

1.2.4.1
date	2007.01.30.01.09.10;	author acolomba;	state Exp;
branches;
next	1.2.4.2;

1.2.4.2
date	2007.01.30.01.32.21;	author acolomba;	state Exp;
branches;
next	;


desc
@@


1.3
log
@merged from rel-0-5-dev
@
text
@;;; The contents of this file are subject to the Mozilla Public License Version
;;; 1.1 (the "License"); you may not use this file except in compliance with
;;; the License. You may obtain a copy of the License at
;;; http://www.mozilla.org/MPL/
;;;
;;; Software distributed under the License is distributed on an "AS IS" basis,
;;; WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
;;; for the specific language governing rights and limitations under the
;;; License.
;;;
;;; The Original Code is SISCweb.
;;;
;;; The Initial Developer of the Original Code is Alessandro Colomba.
;;; Portions created by the Initial Developer are Copyright (C) 2005-2007
;;; Alessandro Colomba. All Rights Reserved.
;;;
;;; Contributor(s):
;;;
;;; Alternatively, the contents of this file may be used under the terms of
;;; either the GNU General Public License Version 2 or later (the "GPL"), or
;;; the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
;;; in which case the provisions of the GPL or the LGPL are applicable instead
;;; of those above. If you wish to allow use of your version of this file only
;;; under the terms of either the GPL or the LGPL, and not to allow others to
;;; use your version of this file under the terms of the MPL, indicate your
;;; decision by deleting the provisions above and replace them with the notice
;;; and other provisions required by the GPL or the LGPL. If you do not delete
;;; the provisions above, a recipient may use your version of this file under
;;; the terms of any one of the MPL, the GPL or the LGPL.


(require-library 'sisc/libs/srfi/srfi-16) ; syntax for procedures of variable arity
(require-library 'sisc/libs/srfi/srfi-18) ; multithreading support
(require-library 'sisc/libs/srfi/srfi-19) ; time data types and procedures

(require-library 'util/misc)

(module siscweb/context
  (current-context context/get context/get-dispatcher
   context/get-init-parameter context/get-init-parameter-alist
   context/get-init-parameter-hashtable
   context/get-init-parameter-names context/get-java-attribute
   context/get-java-attribute-names context/get-major-version
   context/get-mime-type context/get-minor-version context/get-name
   context/get-named-dispatcher context/get-real-path
   context/get-resource context/get-resource-paths
   context/get-server-info context/log context/make-parameter
   context/open-resource-binary-input-port
   context/remove-java-attribute! context/set-java-attribute!)

  (import s2j)
  (import hashtable)
  (import java-io)

  (import srfi-16)
  ;; time? is defined both in srfi-18 and srfi-19
  (import* srfi-18 make-mutex mutex-lock! mutex-unlock!)
  (import srfi-19)

  (import util/misc)

  (define-generic-java-methods
    (jforward |forward|)
    (jget-attribute |getAttribute|)
    (jget-attribute-names |getAttributeNames|)
    (jget-context |getContext|)
    (jget-init-parameter |getInitParameter|)
    (jget-init-parameter-names |getInitparameterNames|)
    (jget-named-dispatcher |getNamedDispatcher|)
    (jget-request-dispatcher |getRequestDispatcher|)
    (jget-resource |getResource|)
    (jget-resource-as-stream |getResourceAsStream|)
    (jlog |log|)
    (jremove-attribute |removeAttribute|)
    (jset-attribute |setAttribute|)
    (jset-init-parameter |setInitParameter|)
    (jto-string |toString|))


  (define-syntax java-lambda
    (syntax-rules (boolean int
                   Date
                   Enumeration<Object> Enumeration<String>
                   InputStream
                   Object ObjectArray
                   Reader
                   String StringArray StringBuffer
                   void)
      ((_ (boolean java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->boolean (scheme-java-method (current-context))))))
      ((_ (boolean java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (->boolean (scheme-java-method (current-context) (->jstring string))))))
      ((_ (Date java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((ms (->number (scheme-java-method (current-context) (->jstring string)))))
             (if (= -1 ms)
                 #f
                 (make-time 'time-monotonic 0 (quotient ms 1000)))))))
      ((_ (Enumeration<Object> java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((enum (scheme-java-method (current-context))))
             (if (java-null? enum)
                 '()
                 (enumeration/map (lambda (o) o) enum))))))
      ((_ (int java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((n (->number (scheme-java-method (current-context)))))
             (if (= -1 n) #f n)))))
      ((_ (int java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((n (->number (scheme-java-method (current-context)
                                                  (->jstring string)))))
             (if (= -1 n) #f n)))))
      ((_ (Enumeration<String> java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((enum (scheme-java-method (current-context))))
             (if (java-null? enum)
                 '()
                 (enumeration/map ->string enum))))))
      ((_ (InputStream java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->binary-input-port (scheme-java-method (current-context))))))
      ((_ (Object java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (scheme-java-method (current-context)))))
      ((_ (ObjectArray java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((jarray (scheme-java-method (current-context))))
             (if (java-null? jarray)
                 '()
                 (->list jarray))))))
      ((_ (Reader java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->character-input-port (scheme-java-method (current-context))))))
      ((_ (String java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((jstring (scheme-java-method (current-context))))
             (if (java-null? jstring) #f (->string jstring))))))
      ((_ (String java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((jstring (scheme-java-method (current-context) (->jstring string))))
             (if (java-null? jstring) #f (->string jstring))))))
      ((_ (StringArray java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((jarray (scheme-java-method (current-context) (->jstring string))))
             (if (java-null? jarray)
                 '()
                 (map ->string (->list jarray)))))))
      ((_ (StringBuffer java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->string (to-string (scheme-java-method (current-context)))))))
      ((_ (void java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (scheme-java-method (current-context) (->jstring string))
           (void))))))

  ;; DO NOT modify this; it's a copy
  (define-syntax define-java-wrappers
    (syntax-rules ()
      ((_ (name signature-list) ...)
       (begin
         (define name
           (java-lambda signature-list)) ...))))


  (define-java-wrappers
    (context/get-init-parameter (String |getInitParameter| String))
    (context/get-init-parameter-names (Enumeration<String> |getInitParameterNames|))
    (context/get-major-version (int |getMajorVersion|))
    (context/get-mime-type (String |getMimeType| String))
    (context/get-minor-version (int |getMinorVersion|))
    (context/get-real-path (String |getRealPath| String))
    (context/get-server-info (String |getServerInfo|))
    (context/get-name (String |getServletContextName|)))


  (define (context/get-init-parameter-hashtable)
    (alist->hashtable (context/get-init-parameter-alist)))

  (define (context/get-init-parameter-alist)
    (enumeration/map
     (lambda (jname)
       (let ((jvalue (jget-init-parameter (current-context) jname)))
         (when (not (java-null? jvalue)) ; concurrency safeguard
           (cons (->string jname) (->jstring jvalue)))))
     (jget-init-parameter-names (current-context))))


  (define (context/get-scheme-attribute name)
    (let ((jvalue (context/get-java-attribute name)))
      (if (java-null? jvalue)
          #f
          (java-unwrap jvalue))))

  (define (context/set-scheme-attribute! name value)
    (context/set-java-attribute! name (if value (java-wrap value) jnull))
    (void))

  (define (context/remove-scheme-attribute! name)
    (context/remove-java-attribute! name))

  (define context/make-parameter
    (case-lambda
     ((name)
      (context/make-parameter name #f))
     ((name thread-safe?)
      (if thread-safe?
          (let ((mutex (make-mutex)))
            (case-lambda
             (()
              (dynamic-wind
               (lambda () (mutex-lock! mutex))
               (lambda () (context/get-scheme-attribute name))
               (lambda () (mutex-unlock! mutex))))
             ((value)
              (dynamic-wind
               (lambda () (mutex-lock! mutex))
               (lambda ()
                 (if value
                     (begin
                       (context/set-scheme-attribute! name value)
                       value)
                     (context/remove-scheme-attribute! name)))
               (lambda () (mutex-unlock! mutex))))))
          (case-lambda
           (() (context/get-scheme-attribute name))
           ((value)
            (if value
                (begin
                  (context/set-scheme-attribute! name value)
                  value)
                (context/remove-scheme-attribute! name))))))))

  (define (context/get-java-attribute name)
    (jget-attribute (current-context) (->jstring name)))

  (define (context/remove-java-attribute! name)
    (jremove-attribute (current-context) (->jstring name))
    (void))

  (define (context/set-java-attribute! name java-object)
    (jset-attribute (current-context) (->jstring name) java-object)
    (void))

  (define (context/get-java-attribute-names)
    (enumeration/map
     ->string
     (jget-attribute-names (current-context))))


  (define (context/get uripath)
    (jget-context (current-context) (->jstring uripath)))

  (define (context/get-named-dispatcher name)
    (let ((jdispatcher (jget-named-dispatcher (current-context) (->jstring name))))
      (if (java-null? jdispatcher)
          #f
          (lambda (request response)
            (jforward jdispatcher request response)))))

  (define (context/get-dispatcher path)
    (let ((jdispatcher (jget-request-dispatcher (current-context) (->jstring path))))
      (if (java-null? jdispatcher)
          #f
          (lambda (request response)
            (jforward jdispatcher request response)))))

  (define (context/get-resource path)
    (let ((jurl (jget-resource (current-context) (->jstring path))))
      (if (java-null? jurl)
          #f
          (->string (jto-string jurl)))))

  (define (context/open-resource-binary-input-port path)
    (let ((jis (jget-resource-as-stream (current-context) (->jstring path))))
      (if (java-null? jis)
          #f
          (->binary-input-port jis))))

  (define (context/get-resource-paths)
    #f) ; TODO: implement

  (define context/log
    (case-lambda
      ((msg) (jlog (current-context) (->jstring msg)) (void))
      ((msg throwable) (jlog (current-context) (->jstring msg) throwable) (void))))



  (define (current-context)
    *SISCWEB.SERVLET-CONTEXT*)
  )
@


1.2
log
@merged from rel-0-4-dev
@
text
@d14 1
a14 1
;;; Portions created by the Initial Developer are Copyright (C) 2005-2006
d33 2
d56 3
d220 1
a220 1
  (define (context/make-parameter name)
d222 29
a250 8
      (() (context/get-scheme-attribute name))
      ((value)
       (if value
           (begin
             (context/set-scheme-attribute! name value)
             value)
           (context/remove-java-attribute! name)))))

@


1.2.4.1
log
@context/make-parameter now accepts a thread-safe? flag
@
text
@d14 1
a14 1
;;; Portions created by the Initial Developer are Copyright (C) 2005-2007
a32 2
(require-library 'sisc/libs/srfi/srfi-18) ; multithreading support
(require-library 'sisc/libs/srfi/srfi-19) ; time data types and procedures
a53 8
  (import srfi-19)

  ;; time? is defined both in srfi-18 and srfi-19
  (module mutex-srfi-18
    (make-mutex mutex-lock! mutex-unlock!)

    (import srfi-18))
  (import mutex-srfi-18)
d215 1
a215 1
  (define context/make-parameter
d217 8
a224 29
     ((name)
      (context/make-parameter name #f))
     ((name thread-safe?)
      (if thread-safe?
          (let ((mutex (make-mutex)))
            (case-lambda
             (()
              (dynamic-wind
               (lambda () (mutex-lock! mutex))
               (lambda () (context/get-scheme-attribute name))
               (lambda () (mutex-unlock! mutex))))
             ((value)
              (dynamic-wind
               (lambda () (mutex-lock! mutex))
               (lambda ()
                 (if value
                     (begin
                       (context/set-scheme-attribute! name value)
                       value)
                     (context/remove-scheme-attribute! name)))
               (lambda () (mutex-unlock! mutex))))))
          (case-lambda
           (() (context/get-scheme-attribute name))
           ((value)
            (if value
                (begin
                  (context/set-scheme-attribute! name value)
                  value)
                (context/remove-scheme-attribute! name))))))))
@


1.2.4.2
log
@uses import* srfi-18
@
text
@d56 2
d59 5
a63 2
  (import* srfi-18 make-mutex mutex-lock! mutex-unlock!)
  (import srfi-19)
@


1.1
log
@file context.scm was initially added on branch rel-0-4-dev.
@
text
@d1 284
@


1.1.4.1
log
@file context.scm was added on branch rel-0-3-fix on 2006-02-25 17:12:02 +0000
@
text
@@


1.1.4.2
log
@merged from rel-0-4-dev-sisc-1-11
@
text
@a0 94
;;; The contents of this file are subject to the Mozilla Public License Version
;;; 1.1 (the "License"); you may not use this file except in compliance with
;;; the License. You may obtain a copy of the License at
;;; http://www.mozilla.org/MPL/
;;;
;;; Software distributed under the License is distributed on an "AS IS" basis,
;;; WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
;;; for the specific language governing rights and limitations under the
;;; License.
;;;
;;; The Original Code is SISCweb.
;;;
;;; The Initial Developer of the Original Code is Alessandro Colomba.
;;; Portions created by the Initial Developer are Copyright (C) 2005
;;; Alessandro Colomba. All Rights Reserved.
;;;
;;; Contributor(s):
;;;
;;; Alternatively, the contents of this file may be used under the terms of
;;; either the GNU General Public License Version 2 or later (the "GPL"), or
;;; the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
;;; in which case the provisions of the GPL or the LGPL are applicable instead
;;; of those above. If you wish to allow use of your version of this file only
;;; under the terms of either the GPL or the LGPL, and not to allow others to
;;; use your version of this file under the terms of the MPL, indicate your
;;; decision by deleting the provisions above and replace them with the notice
;;; and other provisions required by the GPL or the LGPL. If you do not delete
;;; the provisions above, a recipient may use your version of this file under
;;; the terms of any one of the MPL, the GPL or the LGPL.


(require-library 'util/misc)

(module siscweb/context
  (context/make-parameter
   context/get-init-parameter context/get-init-parameter-names
   context/get-java-attribute context/get-java-attribute-names
   context/remove-java-attribute! context/set-java-attribute!
   get-current-context)

  (import s2j)
  (import hashtable)

  (import util/misc)

  (define-generic-java-methods
    get-attribute get-attribute-names
    get-init-parameter get-init-parameter-names
    remove-attribute set-attribute
    set-init-parameter)


  (define (context/make-parameter name)
    (lambda x
      (if (pair? x)
          (set-scheme-attribute! name (car x))
          (get-scheme-attribute name))))

  (define (context/get-init-parameter name)
    (->string (get-init-parameter (get-current-context) (->jstring name))))

  (define (context/get-init-parameter-names)
    (enumeration/map
     ->symbol
     (get-init-parameter-names (get-current-context))))

  (define (context/get-java-attribute name)
    (get-attribute (get-current-context) (->jstring name)))

  (define (context/remove-java-attribute! name)
    (remove-attribute (get-current-context) (->jstring name)))

  (define (context/set-java-attribute! name java-object)
    (set-attribute (get-current-context) (->jstring name) java-object))

  (define (context/get-java-attribute-names)
    (enumeration/map
     ->symbol
     (get-attribute-names (get-current-context))))


  (define (get-scheme-attribute name)
    (let ((jvalue (context/get-java-attribute name)))
      (if (java-null? jvalue)
          #f
          (java-unwrap jvalue))))

  (define (set-scheme-attribute! name value)
    (context/set-java-attribute! name (if value (java-wrap value) jnull)))


  (define (get-current-context)
    *SISCWEB.SERVLET-CONTEXT*)
  )
@


1.1.4.3
log
@merged from rel-0-4-dev
@
text
@d14 1
a14 1
;;; Portions created by the Initial Developer are Copyright (C) 2005-2006
a31 2
(require-library 'sisc/libs/srfi/srfi-16) ; syntax for procedures of variable arity

a32 1
(require-library 'util/s2j-io)
d35 5
a39 11
  (current-context context/get context/get-dispatcher
   context/get-init-parameter context/get-init-parameter-alist
   context/get-init-parameter-hashtable
   context/get-init-parameter-names context/get-java-attribute
   context/get-java-attribute-names context/get-major-version
   context/get-mime-type context/get-minor-version context/get-name
   context/get-named-dispatcher context/get-real-path
   context/get-resource context/get-resource-paths
   context/get-server-info context/log context/make-parameter
   context/open-resource-binary-input-port
   context/remove-java-attribute! context/set-java-attribute!)
a43 2
  (import srfi-16)

a44 1
  (import util/s2j-io)
d47 4
a50 130
    (jforward |forward|)
    (jget-attribute |getAttribute|)
    (jget-attribute-names |getAttributeNames|)
    (jget-context |getContext|)
    (jget-init-parameter |getInitParameter|)
    (jget-init-parameter-names |getInitparameterNames|)
    (jget-named-dispatcher |getNamedDispatcher|)
    (jget-request-dispatcher |getRequestDispatcher|)
    (jget-resource |getResource|)
    (jget-resource-as-stream |getResourceAsStream|)
    (jlog |log|)
    (jremove-attribute |removeAttribute|)
    (jset-attribute |setAttribute|)
    (jset-init-parameter |setInitParameter|)
    (jto-string |toString|))


  (define-syntax java-lambda
    (syntax-rules (boolean int
                   Date
                   Enumeration<Object> Enumeration<String>
                   InputStream
                   Object ObjectArray
                   Reader
                   String StringArray StringBuffer
                   void)
      ((_ (boolean java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->boolean (scheme-java-method (current-context))))))
      ((_ (boolean java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (->boolean (scheme-java-method (current-context) (->jstring string))))))
      ((_ (Date java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((ms (->number (scheme-java-method (current-context) (->jstring string)))))
             (if (= -1 ms)
                 #f
                 (make-time 'time-monotonic 0 (quotient ms 1000)))))))
      ((_ (Enumeration<Object> java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((enum (scheme-java-method (current-context))))
             (if (java-null? enum)
                 '()
                 (enumeration/map (lambda (o) o) enum))))))
      ((_ (int java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((n (->number (scheme-java-method (current-context)))))
             (if (= -1 n) #f n)))))
      ((_ (int java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((n (->number (scheme-java-method (current-context)
                                                  (->jstring string)))))
             (if (= -1 n) #f n)))))
      ((_ (Enumeration<String> java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((enum (scheme-java-method (current-context))))
             (if (java-null? enum)
                 '()
                 (enumeration/map ->string enum))))))
      ((_ (InputStream java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->binary-input-port (scheme-java-method (current-context))))))
      ((_ (Object java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (scheme-java-method (current-context)))))
      ((_ (ObjectArray java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((jarray (scheme-java-method (current-context))))
             (if (java-null? jarray)
                 '()
                 (->list jarray))))))
      ((_ (Reader java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->character-input-port (scheme-java-method (current-context))))))
      ((_ (String java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((jstring (scheme-java-method (current-context))))
             (if (java-null? jstring) #f (->string jstring))))))
      ((_ (String java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((jstring (scheme-java-method (current-context) (->jstring string))))
             (if (java-null? jstring) #f (->string jstring))))))
      ((_ (StringArray java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((jarray (scheme-java-method (current-context) (->jstring string))))
             (if (java-null? jarray)
                 '()
                 (map ->string (->list jarray)))))))
      ((_ (StringBuffer java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->string (to-string (scheme-java-method (current-context)))))))
      ((_ (void java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (scheme-java-method (current-context) (->jstring string))
           (void))))))

  ;; DO NOT modify this; it's a copy
  (define-syntax define-java-wrappers
    (syntax-rules ()
      ((_ (name signature-list) ...)
       (begin
         (define name
           (java-lambda signature-list)) ...))))


  (define-java-wrappers
    (context/get-init-parameter (String |getInitParameter| String))
    (context/get-init-parameter-names (Enumeration<String> |getInitParameterNames|))
    (context/get-major-version (int |getMajorVersion|))
    (context/get-mime-type (String |getMimeType| String))
    (context/get-minor-version (int |getMinorVersion|))
    (context/get-real-path (String |getRealPath| String))
    (context/get-server-info (String |getServerInfo|))
    (context/get-name (String |getServletContextName|)))
d53 8
a60 2
  (define (context/get-init-parameter-hashtable)
    (alist->hashtable (context/get-init-parameter-alist)))
d62 1
a62 1
  (define (context/get-init-parameter-alist)
d64 2
a65 30
     (lambda (jname)
       (let ((jvalue (jget-init-parameter (current-context) jname)))
         (when (not (java-null? jvalue)) ; concurrency safeguard
           (cons (->string jname) (->jstring jvalue)))))
     (jget-init-parameter-names (current-context))))


  (define (context/get-scheme-attribute name)
    (let ((jvalue (context/get-java-attribute name)))
      (if (java-null? jvalue)
          #f
          (java-unwrap jvalue))))

  (define (context/set-scheme-attribute! name value)
    (context/set-java-attribute! name (if value (java-wrap value) jnull))
    (void))

  (define (context/remove-scheme-attribute! name)
    (context/remove-java-attribute! name))

  (define (context/make-parameter name)
    (case-lambda
      (() (context/get-scheme-attribute name))
      ((value)
       (if value
           (begin
             (context/set-scheme-attribute! name value)
             value)
           (context/remove-java-attribute! name)))))

d68 1
a68 1
    (jget-attribute (current-context) (->jstring name)))
d71 1
a71 2
    (jremove-attribute (current-context) (->jstring name))
    (void))
d74 1
a74 2
    (jset-attribute (current-context) (->jstring name) java-object)
    (void))
d78 2
a79 2
     ->string
     (jget-attribute-names (current-context))))
d82 3
a84 6
  (define (context/get uripath)
    (jget-context (current-context) (->jstring uripath)))

  (define (context/get-named-dispatcher name)
    (let ((jdispatcher (jget-named-dispatcher (current-context) (->jstring name))))
      (if (java-null? jdispatcher)
d86 1
a86 29
          (lambda (request response)
            (jforward jdispatcher request response)))))

  (define (context/get-dispatcher path)
    (let ((jdispatcher (jget-request-dispatcher (current-context) (->jstring path))))
      (if (java-null? jdispatcher)
          #f
          (lambda (request response)
            (jforward jdispatcher request response)))))

  (define (context/get-resource path)
    (let ((jurl (jget-resource (current-context) (->jstring path))))
      (if (java-null? jurl)
          #f
          (->string (jto-string jurl)))))

  (define (context/open-resource-binary-input-port path)
    (let ((jis (jget-resource-as-stream (current-context) (->jstring path))))
      (if (java-null? jis)
          #f
          (->binary-input-port jis))))

  (define (context/get-resource-paths)
    #f) ; TODO: implement

  (define context/log
    (case-lambda
      ((msg) (jlog (current-context) (->jstring msg)) (void))
      ((msg throwable) (jlog (current-context) (->jstring msg) throwable) (void))))
d88 2
d92 1
a92 1
  (define (current-context)
@


1.1.2.1
log
@initial import
@
text
@a0 96
;;; The contents of this file are subject to the Mozilla Public License Version
;;; 1.1 (the "License"); you may not use this file except in compliance with
;;; the License. You may obtain a copy of the License at
;;; http://www.mozilla.org/MPL/
;;;
;;; Software distributed under the License is distributed on an "AS IS" basis,
;;; WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
;;; for the specific language governing rights and limitations under the
;;; License.
;;;
;;; The Original Code is SISCweb.
;;;
;;; The Initial Developer of the Original Code is Alessandro Colomba.
;;; Portions created by the Initial Developer are Copyright (C) 2005
;;; Alessandro Colomba. All Rights Reserved.
;;;
;;; Contributor(s):
;;;
;;; Alternatively, the contents of this file may be used under the terms of
;;; either the GNU General Public License Version 2 or later (the "GPL"), or
;;; the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
;;; in which case the provisions of the GPL or the LGPL are applicable instead
;;; of those above. If you wish to allow use of your version of this file only
;;; under the terms of either the GPL or the LGPL, and not to allow others to
;;; use your version of this file under the terms of the MPL, indicate your
;;; decision by deleting the provisions above and replace them with the notice
;;; and other provisions required by the GPL or the LGPL. If you do not delete
;;; the provisions above, a recipient may use your version of this file under
;;; the terms of any one of the MPL, the GPL or the LGPL.


(require-library 'siscweb/contcentric)
(require-library 'util/misc)

(module siscweb/context
  (context/make-parameter
   context/get-init-parameter context/get-init-parameter-names
   context/get-java-attribute context/get-java-attribute-names
   context/remove-java-attribute! context/set-java-attribute!
   current-context)

  (import s2j)
  (import hashtable)

  (import siscweb/contcentric)
  (import util/misc)

  (define-generic-java-methods
    get-attribute get-attribute-names
    get-init-parameter get-init-parameter-names
    remove-attribute set-attribute
    set-init-parameter)


  (define (context/make-parameter name)
    (lambda x
      (if (pair? x)
          (set-scheme-attribute! name (car x))
          (get-scheme-attribute name))))

  (define (context/get-init-parameter name)
    (->string (get-init-parameter (current-context) (->jstring name))))

  (define (context/get-init-parameter-names)
    (enumeration/map
     ->symbol
     (get-init-parameter-names (current-context))))

  (define (context/get-java-attribute name)
    (get-attribute (current-context) (->jstring name)))

  (define (context/remove-java-attribute! name)
    (remove-attribute (current-context) (->jstring name)))

  (define (context/set-java-attribute! name java-object)
    (set-attribute (current-context) (->jstring name) java-object))

  (define (context/get-java-attribute-names)
    (enumeration/map
     ->symbol
     (get-attribute-names (current-context))))


  (define (get-scheme-attribute name)
    (let ((jvalue (context/get-java-attribute name)))
      (if (java-null? jvalue)
          #f
          (java-unwrap jvalue))))

  (define (set-scheme-attribute! name value)
    (context/set-java-attribute! name (if value (java-wrap value) jnull)))


  (define (current-context)
    *SERVLET-CONTEXT*)
  )
@


1.1.2.2
log
@added siscweb/context module
@
text
@d32 1
d40 1
a40 1
   get-current-context)
d45 1
d62 1
a62 1
    (->string (get-init-parameter (get-current-context) (->jstring name))))
d67 1
a67 1
     (get-init-parameter-names (get-current-context))))
d70 1
a70 1
    (get-attribute (get-current-context) (->jstring name)))
d73 1
a73 1
    (remove-attribute (get-current-context) (->jstring name)))
d76 1
a76 1
    (set-attribute (get-current-context) (->jstring name) java-object))
d81 1
a81 1
     (get-attribute-names (get-current-context))))
d94 2
a95 2
  (define (get-current-context)
    *SISCWEB.SERVLET-CONTEXT*)
@


1.1.2.3
log
@completed api
@
text
@d14 1
a14 1
;;; Portions created by the Initial Developer are Copyright (C) 2005-2006
a31 2
(require-library 'sisc/libs/srfi/srfi-16) ; syntax for procedures of variable arity

a32 3
(require-library 'util/s2j-io)

;; TODO: make-parameter doesn't work
d35 1
a35 1
  (current-context context/get-context context/get-dispatcher
d37 3
a39 7
   context/get-java-attribute context/get-major-version
   context/get-mime-type context/get-minor-version context/get-name
   context/get-named-dispatcher context/get-real-path
   context/get-resource context/get-resource-paths
   context/get-server-info context/log context/make-parameter
   context/open-resource-binary-input-port
   context/remove-java-attribute! context/set-java-attribute!)
a43 2
  (import srfi-16)

a44 1
  (import util/s2j-io)
d47 4
a50 130
    (jforward |forward|)
    (jget-attribute |getAttribute|)
    (jget-attribute-names |getAttributeNames|)
    (jget-context |getContext|)
    (jget-init-parameter |getInitParameter|)
    (jget-init-parameter-names |getInitparameterNames|)
    (jget-named-dispatcher |getNamedDispatcher|)
    (jget-request-dispatcher |getRequestDispatcher|)
    (jget-resource |getResource|)
    (jget-resource-as-stream |getResourceAsStream|)
    (jlog |log|)
    (jremove-attribute |removeAttribute|)
    (jset-attribute |setAttribute|)
    (jset-init-parameter |setInitParameter|)
    (jto-string |toString|))


  (define-syntax java-lambda
    (syntax-rules (boolean int
                   Date
                   Enumeration<Object> Enumeration<String>
                   InputStream
                   Object ObjectArray
                   Reader
                   String StringArray StringBuffer
                   void)
      ((_ (boolean java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->boolean (scheme-java-method (current-context))))))
      ((_ (boolean java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (->boolean (scheme-java-method (current-context) (->jstring string))))))
      ((_ (Date java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((ms (->number (scheme-java-method (current-context) (->jstring string)))))
             (if (= -1 ms)
                 #f
                 (make-time 'time-monotonic 0 (quotient ms 1000)))))))
      ((_ (Enumeration<Object> java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((enum (scheme-java-method (current-context))))
             (if (java-null? enum)
                 '()
                 (enumeration/map (lambda (o) o) enum))))))
      ((_ (int java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((n (->number (scheme-java-method (current-context)))))
             (if (= -1 n) #f n)))))
      ((_ (int java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((n (->number (scheme-java-method (current-context)
                                                  (->jstring string)))))
             (if (= -1 n) #f n)))))
      ((_ (Enumeration<String> java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((enum (scheme-java-method (current-context))))
             (if (java-null? enum)
                 '()
                 (enumeration/map ->string enum))))))
      ((_ (InputStream java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->binary-input-port (scheme-java-method (current-context))))))
      ((_ (Object java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (scheme-java-method (current-context)))))
      ((_ (ObjectArray java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((jarray (scheme-java-method (current-context))))
             (if (java-null? jarray)
                 '()
                 (->list jarray))))))
      ((_ (Reader java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->character-input-port (scheme-java-method (current-context))))))
      ((_ (String java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (let ((jstring (scheme-java-method (current-context))))
             (if (java-null? jstring) #f (->string jstring))))))
      ((_ (String java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((jstring (scheme-java-method (current-context) (->jstring string))))
             (if (java-null? jstring) #f (->string jstring))))))
      ((_ (StringArray java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (let ((jarray (scheme-java-method (current-context) (->jstring string))))
             (if (java-null? jarray)
                 '()
                 (map ->string (->list jarray)))))))
      ((_ (StringBuffer java-method))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda ()
           (->string (to-string (scheme-java-method (current-context)))))))
      ((_ (void java-method String))
       (let ((scheme-java-method (generic-java-method (quote java-method))))
         (lambda (string)
           (scheme-java-method (current-context) (->jstring string))
           (void))))))

  ;; DO NOT modify this; it's a copy
  (define-syntax define-java-wrappers
    (syntax-rules ()
      ((_ (name signature-list) ...)
       (begin
         (define name
           (java-lambda signature-list)) ...))))


  (define-java-wrappers
    (context/get-init-parameter (String |getInitParameter| String))
    (context/get-init-parameter-names (Enumeration<String> |getInitParameterNames|))
    (context/get-major-version (int |getMajorVersion|))
    (context/get-mime-type (String |getMimeType| String))
    (context/get-minor-version (int |getMinorVersion|))
    (context/get-real-path (String |getRealPath| String))
    (context/get-server-info (String |getServerInfo|))
    (context/get-name (String |getServletContextName|)))
d53 8
a60 2
  (define (context/get-init-parameter-hashtable)
    (alist->hashtable (context/get-init-parameter-alist)))
d62 1
a62 1
  (define (context/get-init-parameter-alist)
d64 2
a65 30
     (lambda (jname)
       (let ((jvalue (jget-init-parameter (current-context) jname)))
         (when (not (java-null? jvalue)) ; concurrency safeguard
           (cons (->string jname) (->jstring jvalue)))))
     (jget-init-parameter-names (current-context))))


  (define (context/get-scheme-attribute name)
    (let ((jvalue (context/get-java-attribute name)))
      (if (java-null? jvalue)
          #f
          (java-unwrap jvalue))))

  (define (context/set-scheme-attribute! name value)
    (context/set-java-attribute! name (if value (java-wrap value) jnull))
    (void))

  (define (context/remove-scheme-attribute! name)
    (context/remove-java-attribute! name))

  (define (context/make-parameter name)
    (case-lambda
      (() (context/get-scheme-attribute name))
      ((value)
       (if value
           (begin
             (context/set-scheme-attribute! name value)
             value)
           (context/remove-java-attribute! name)))))

d68 1
a68 1
    (jget-attribute (current-context) (->jstring name)))
d71 1
a71 2
    (jremove-attribute (current-context) (->jstring name))
    (void))
d74 1
a74 2
    (jset-attribute (current-context) (->jstring name) java-object)
    (void))
d78 2
a79 2
     ->string
     (jget-attribute-names (current-context))))
d82 3
a84 16
  (define (context/get-context uripath)
    (jget-context (current-context) (->jstring uripath)))

  (define (context/get-named-dispatcher name)
    (let ((jdispatcher (jget-named-dispatcher (current-context) (->jstring name))))
      (lambda (request response)
        (jforward jdispatcher request response))))

  (define (context/get-dispatcher path)
    (let ((jdispatcher (jget-request-dispatcher (current-context) (->jstring path))))
      (lambda (request response)
        (jforward jdispatcher request response))))

  (define (context/get-resource path)
    (let ((jurl (jget-resource (current-context) (->jstring path))))
      (if (java-null? jurl)
d86 1
a86 15
          (->string (jto-string jurl)))))

  (define (context/open-resource-binary-input-port path)
    (let ((jis (jget-resource-as-stream (current-context) (->jstring path))))
      (if (java-null? jis)
          #f
          (->binary-input-port jis))))

  (define (context/get-resource-paths)
    #f) ; TODO: implement

  (define context/log
    (case-lambda
      ((msg) (jlog (current-context) (->jstring msg)) (void))
      ((msg throwable) (jlog (current-context) (->jstring msg) throwable) (void))))
d88 2
d92 1
a92 1
  (define (current-context)
@


1.1.2.4
log
@renamed context/get-context to context/get; get-*-dispatcher now
return #f instead of jnull
@
text
@d37 2
d40 3
a42 5
  (current-context context/get context/get-dispatcher
   context/get-init-parameter context/get-init-parameter-alist
   context/get-init-parameter-hashtable
   context/get-init-parameter-names context/get-java-attribute
   context/get-java-attribute-names context/get-major-version
d244 1
a244 1
  (define (context/get uripath)
d249 2
a250 4
      (if (java-null? jdispatcher)
          #f
          (lambda (request response)
            (jforward jdispatcher request response)))))
d254 2
a255 4
      (if (java-null? jdispatcher)
          #f
          (lambda (request response)
            (jforward jdispatcher request response)))))
@


1.1.2.5
log
@switched from using util/s2j-io to using SISC's java-io library (same code really)
@
text
@d35 1
a51 1
  (import java-io)
d56 1
@


